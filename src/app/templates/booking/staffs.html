<script>
    let userId = null;
    let fullname = null;
    let serviceId = '{{ service_id }}';
    let staffs = [];

    // Безопасное получение данных из шаблона
    try {
        staffs = JSON.parse('{{ staffs | safe }}');
    } catch (e) {
        console.error(`Ошибка парсинга данных staffs: ${e}`);
        staffs = [];
    }

    if (localStorage.getItem('user') && localStorage.getItem('fullname')) {
        userId = localStorage.getItem('user');
        fullname = localStorage.getItem('fullname');
    }

    const go_to_dates = async (staff_id, staff_username) => {
        localStorage.setItem('user', userId);
        localStorage.setItem("selectPerson", staff_username);
        location.replace(`/book_record/category/services/${serviceId}/${staff_id}`);
    };

    async function sendServiceId(staff, staff_username) {
        const payload = {
            user_id: userId,
            fullname: fullname,
            service_id: serviceId,
            staff_id: staff
        };
        try {
            const response = await fetch(`/book_record/category/services/${serviceId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                throw new Error(`Ошибка HTTP: ${response.status}`);
            }
        } catch (e) {
            console.error("Ошибка отправки данных:", e);
        }
        await go_to_dates(staff, staff_username);
    }

    document.getElementById('searchFieldId').addEventListener('input', function () {
        let filter = this.value.toLowerCase();
        let chatCards = document.querySelectorAll('.container-sm');

        chatCards.forEach(card => {
            let name = card.querySelector('.name-staff').textContent.toLowerCase();
            card.style.display = name.includes(filter) ? '' : 'none';
        });
    });

    function loadStaffs(staffs) {
        const cards = document.getElementById('rowId');
        cards.innerHTML = ''; // Очищаем контейнер перед добавлением
        staffs.forEach(staff => {
            const div = document.createElement('div');
            div.className = 'container-sm';
            div.innerHTML = `
                <div class="container-sm-1">
                    <img src="${staff.staff_avatar || '/path/to/default/avatar.jpg'}" alt="Avatar"/>
                    <div class="name-staff">${staff.staff_name || 'Имя не указано'}</div>
                </div>
                <div class="mb-3">
                    <p>${staff.staff_specialization || 'Специализация не указана'}</p>
                </div>
                <div class="mb-3">
                    <p>${staff.staff_info || 'Информация отсутствует'}</p>
                </div>
                <button
                    id="${staff.staff_id}"
                    class="btn"
                    onclick="sendServiceId('${staff.staff_id}', '${staff.staff_name}')"
                >Выбрать</button>
            `;
            cards.appendChild(div);
        });
    }

    window.addEventListener('DOMContentLoaded', () => {
        if (staffs && Array.isArray(staffs)) {
            loadStaffs(staffs);
        } else {
            console.error('Некорректный формат данных staffs.');
        }
    });
</script>
